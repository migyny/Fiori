<!DOCTYPE html>
<!--account.html-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Account - Fiori</title>

  <!--fonts-->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rosarivo:ital@0;1&family=Public+Sans:wght@300;400;500;700&family=Plus+Jakarta+Sans:wght@500;600&display=swap" rel="stylesheet">

  <!--styles-->
  <link rel="stylesheet" href="../CSS/catalogue.css">
  <link rel="stylesheet" href="../CSS/cart.css">
  <link rel="stylesheet" href="../CSS/checkout.css">

  <!--scripts-->
  <script src="../Javascript/cart.js"></script>
  <script src="../Javascript/search.js"></script>
</head>

  <style>
    .account-info { margin-bottom: 20px; }
    .account-info h2 { margin-bottom: 10px; font-size: 22px; }
    .account-info p { margin: 5px 0; font-size: 16px; }
    .edit-btn, .save-btn { margin-top: 10px; cursor: pointer; font-weight: 600; }
    .input-field { margin-bottom: 10px; }
    .orders { margin-bottom: 30px; }
    .order { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
    .order h4 { margin: 0 0 5px; }
    .order-item { display: flex; justify-content: space-between; }
    .checkout-btn { width: 350px; height: 50px; padding: 4px 8px; font-size: 12px; border-radius: 4px; }
    .edit-btn { width: 100px; height: 50px; padding: 4px 8px; font-size: 12px; border-radius: 4px; }
    .account-btn {
        width: 150px;
        height: 40px;
        padding: 5px 10px;
        font-size: 14px;
        border-radius: 6px;
}
  </style>
</head>

<body>
        <!--top banner-->
  <div class="top-banner"> Free Same Day Delivery for Orders Over $44.99. *Exclusions Apply.</div>

  <!--header-->
  <div class="header">
    <div class="header-content">
      <div class="logo" onclick="location.href='index.html'" style="cursor: pointer;">Fiori</div>
      <div class="nav-buttons">
        <button class="nav-button" onclick="navigateTo('best-sellers')">Best Sellers</button>
        <button class="nav-button" onclick="navigateTo('occasion')">Occasion</button>
        <button class="nav-button" onclick="navigateTo('seasonal')">Seasonal</button>
        <button class="nav-button" onclick="navigateTo('diy')">DIY Bouquets</button>
        <button class="nav-button" onclick="navigateTo('ai')">Build With AI</button>
        <button class="nav-button" onclick="location.href='catalogue.html'">Full Catalog</button>
      </div>
    </div>

    <div class="header-icons">
      <!--search icon-->
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5">
        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>

      <!--account button-->
      <div class="account-wrapper" style="display:flex; align-items:center; cursor:pointer;">
        <svg class="icon" id="account-button" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5"
          width="30" height="30">
          <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        <span id="account-text" style="margin-left:5px; font-size:14px; color:white;"></span>
      </div>

      <!--cart icon-->
      <div class="cart-icon-wrapper" onclick="openCart()" style="cursor: pointer;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5">
          <path
            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <span id="cart-badge">0</span>
      </div>
    </div>
  </div>

  <div class="checkout-container">
    <h1 class="checkout-title">My Account</h1>

    <section class="account-info">
      <h2>Account Information</h2>
      <p><strong>Name:</strong> <span id="display-name"></span></p>
      <p><strong>Email:</strong> <span id="display-email"></span></p>
    </section>

    <section class="account-info">
      <h2>Address</h2>
      <div id="address-display">
        <p><strong>Street:</strong> <span id="display-street"></span></p>
        <p><strong>City:</strong> <span id="display-city"></span></p>
        <p><strong>State / Province:</strong> <span id="display-state"></span></p>
        <p><strong>Postal Code:</strong> <span id="display-postal"></span></p>
        <p><strong>Country:</strong> <span id="display-country"></span></p>
        <button class="checkout-btn edit-btn account-btn" onclick="editAddress()">Edit Address</button>

      </div>
      <div id="address-edit" style="display:none;">
        <input type="text" id="edit-street" class="input-field" placeholder="Street Address">
        <input type="text" id="edit-city" class="input-field" placeholder="City">
        <input type="text" id="edit-state" class="input-field" placeholder="State / Province">
        <input type="text" id="edit-postal" class="input-field" placeholder="Postal Code">
        <input type="text" id="edit-country" class="input-field" placeholder="Country">
        <button class="checkout-btn save-btn" onclick="saveAddress()">Save Address</button>
      </div>
    </section>

    <section class="orders">
      <h2>Previous Orders</h2>
      <div id="orders-list"><p>No previous orders.</p></div>
    </section>

    <button class="checkout-btn account-btn" onclick="logout()">Log Out</button>    
  </div>

<script>
  document.addEventListener("DOMContentLoaded", async () => {

    // 2. Get User Data
    const userString = localStorage.getItem("fioriUser");
    
    if (!userString) {
      window.location.href = "sign_in.html";
      return;
    }

    const user = JSON.parse(userString);

    // 3. Display Basic Info
    document.getElementById("display-name").textContent = user.name || "No Name";
    document.getElementById("display-email").textContent = user.email || "No Email";

    // Display Address safely
    if (user.address) {
      const parts = user.address.split(',').map(s => s.trim());
      document.getElementById("display-street").textContent = parts[0] || "-";
      document.getElementById("display-city").textContent = parts[1] || "-";
      if (parts[2]) {
        const stateZip = parts[2].split(' ');
        document.getElementById("display-state").textContent = stateZip[0] || "-";
        document.getElementById("display-postal").textContent = stateZip[1] || "-";
      }
      document.getElementById("display-country").textContent = parts[3] || "-";
    }

    // 4. Fetch Previous Orders
    const ordersList = document.getElementById("orders-list");
    ordersList.innerHTML = "<p>Loading orders...</p>";

    if (!user.customerId) {
      ordersList.innerHTML = "<p>No Customer ID found. Please Sign In again.</p>";
      return;
    }

    try {
      const response = await fetch(`http://localhost:3000/api/orders/${user.customerId}`);
      const orders = await response.json();

      ordersList.innerHTML = ""; // Clear loading message

      if (orders.length === 0) {
        ordersList.innerHTML = "<p>No previous orders found.</p>";
        return;
      }

      orders.forEach(order => {
        const orderDiv = document.createElement("div");
        orderDiv.classList.add("order");
        
        // Format Date
        const dateObj = new Date(order.date);
        const dateStr = dateObj.toLocaleDateString();

        // Calculate Items Summary
        const itemSummary = order.items.map(i => `${i.name} (x${i.quantity})`).join(", ");

        // === SPECIFIC LAYOUT FOR ORDER ID, DATE, TOTAL ===
        orderDiv.innerHTML = `
          <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: white;">
            <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
              <span style="font-weight: 700; font-size: 16px;">Order ID: #${order.id}</span>
              <span style="color: #666;">Date: ${dateStr}</span>
            </div>
            
            <div style="font-size: 14px; color: #444; margin-bottom: 10px;">
              <strong>Items:</strong> ${itemSummary}
            </div>

            <div style="text-align: right; font-size: 18px; font-weight: 700; color: #1E1E1E;">
              Total Amount: $${parseFloat(order.total).toFixed(2)}
            </div>
          </div>
        `;
        ordersList.appendChild(orderDiv);
      });

    } catch (error) {
      console.error("Fetch Error:", error);
      ordersList.innerHTML = `<p style="color:red;">Could not load orders. Ensure server is running.</p>`;
    }

    window.logout = function() {
      localStorage.removeItem("fioriUser");
      localStorage.removeItem("fioriCart");
      window.location.href = "index.html";
    };
  });
</script>


</body>
</html>
